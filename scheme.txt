CREATE SCHEMA "public";
CREATE SCHEMA "pgrst";
CREATE SCHEMA "neon_auth";
CREATE SCHEMA "auth";
CREATE TYPE "Channel" AS ENUM('BOOKING', 'AIRBNB', 'AGODA', 'MANUAL', 'OTHER');
CREATE TYPE "FeedType" AS ENUM('URL', 'INLINE');
CREATE TYPE "PaymentStatus" AS ENUM('UNPAID', 'PARTIAL', 'PAID');
CREATE TYPE "ExpenseCategory" AS ENUM('CLEANING', 'MAINTENANCE', 'UTILITIES', 'SUPPLIES', 'STAFF', 'OTHER');
CREATE TYPE "PayoutStatus" AS ENUM('PENDING', 'RECEIVED');
CREATE TABLE "Booking" (
	"id" text PRIMARY KEY,
	"unitId" text NOT NULL,
	"channel" Channel NOT NULL,
	"externalUid" text NOT NULL,
	"summary" text,
	"startDate" timestamp NOT NULL,
	"endDate" timestamp NOT NULL,
	"lastSeenAt" timestamp DEFAULT CURRENT_TIMESTAMP NOT NULL,
	"isCancelled" boolean DEFAULT false NOT NULL,
	"currency" text DEFAULT 'BHD' NOT NULL,
	"grossAmount" numeric(12, 3),
	"commissionAmount" numeric(12, 3),
	"taxAmount" numeric(12, 3),
	"otherFeesAmount" numeric(12, 3),
	"netAmount" numeric(12, 3),
	"paymentStatus" PaymentStatus DEFAULT 'UNPAID' NOT NULL,
	"notes" text,
	"createdAt" timestamp DEFAULT CURRENT_TIMESTAMP NOT NULL,
	"updatedAt" timestamp NOT NULL
);
CREATE TABLE "ChannelContent" (
	"id" text PRIMARY KEY,
	"unitContentId" text NOT NULL,
	"channel" Channel NOT NULL,
	"title" text,
	"description" text,
	"houseRules" text,
	"checkInInfo" text,
	"checkOutInfo" text,
	"amenities" jsonb,
	"images" jsonb,
	"listingUrl" text,
	"createdAt" timestamp DEFAULT CURRENT_TIMESTAMP NOT NULL,
	"updatedAt" timestamp NOT NULL
);
CREATE TABLE "ChannelListing" (
	"id" text PRIMARY KEY,
	"unitId" text NOT NULL,
	"channel" Channel NOT NULL,
	"externalId" text NOT NULL,
	"publicUrl" text,
	"editUrl" text,
	"createdAt" timestamp DEFAULT CURRENT_TIMESTAMP NOT NULL,
	"updatedAt" timestamp NOT NULL
);
CREATE TABLE "ChannelOpsSnapshot" (
	"id" text PRIMARY KEY,
	"unitId" text NOT NULL,
	"channel" Channel DEFAULT 'BOOKING' NOT NULL,
	"statusText" text,
	"locationText" text,
	"checkins48h" integer DEFAULT 0 NOT NULL,
	"checkouts48h" integer DEFAULT 0 NOT NULL,
	"guestMessagesCount" integer DEFAULT 0 NOT NULL,
	"bookingMessagesCount" integer DEFAULT 0 NOT NULL,
	"capturedAt" timestamp DEFAULT CURRENT_TIMESTAMP NOT NULL
);
CREATE TABLE "DateBlock" (
	"id" text PRIMARY KEY,
	"unitId" text NOT NULL,
	"date" timestamp NOT NULL,
	"source" text DEFAULT 'MANUAL' NOT NULL,
	"reason" text,
	"createdAt" timestamp DEFAULT CURRENT_TIMESTAMP NOT NULL
);
CREATE TABLE "Expense" (
	"id" text PRIMARY KEY,
	"unitId" text NOT NULL,
	"category" ExpenseCategory DEFAULT 'OTHER' NOT NULL,
	"amount" numeric(12, 3) NOT NULL,
	"currency" text DEFAULT 'BHD' NOT NULL,
	"spentAt" timestamp NOT NULL,
	"note" text,
	"createdAt" timestamp DEFAULT CURRENT_TIMESTAMP NOT NULL
);
CREATE TABLE "IcalFeed" (
	"id" text PRIMARY KEY,
	"unitId" text NOT NULL,
	"channel" Channel NOT NULL,
	"type" FeedType NOT NULL,
	"name" text,
	"url" text,
	"icsText" text,
	"lastSyncAt" timestamp,
	"lastEtag" text,
	"lastModified" text,
	"lastError" text,
	"createdAt" timestamp DEFAULT CURRENT_TIMESTAMP NOT NULL,
	"updatedAt" timestamp NOT NULL
);
CREATE TABLE "Payout" (
	"id" text PRIMARY KEY,
	"channel" Channel NOT NULL,
	"payoutDate" timestamp NOT NULL,
	"currency" text DEFAULT 'BHD' NOT NULL,
	"amount" numeric(12, 3) NOT NULL,
	"providerRef" text,
	"status" PayoutStatus DEFAULT 'RECEIVED' NOT NULL,
	"note" text,
	"createdAt" timestamp DEFAULT CURRENT_TIMESTAMP NOT NULL
);
CREATE TABLE "PayoutLine" (
	"id" text PRIMARY KEY,
	"payoutId" text NOT NULL,
	"bookingId" text,
	"amount" numeric(12, 3) NOT NULL,
	"note" text,
	"createdAt" timestamp DEFAULT CURRENT_TIMESTAMP NOT NULL
);
CREATE TABLE "PublicPreviewCache" (
	"id" text PRIMARY KEY,
	"url" text NOT NULL,
	"ogTitle" text,
	"ogDesc" text,
	"ogImage" text,
	"images" jsonb,
	"amenities" jsonb,
	"details" jsonb,
	"fetchedAt" timestamp DEFAULT CURRENT_TIMESTAMP NOT NULL,
	"ttlSeconds" integer DEFAULT 86400 NOT NULL
);
CREATE TABLE "PublishSnapshot" (
	"id" text PRIMARY KEY,
	"unitId" text NOT NULL,
	"channel" Channel NOT NULL,
	"section" text NOT NULL,
	"checksum" text NOT NULL,
	"snapshot" jsonb NOT NULL,
	"publishedAt" timestamp DEFAULT CURRENT_TIMESTAMP NOT NULL,
	"note" text
);
CREATE TABLE "RateRule" (
	"id" text PRIMARY KEY,
	"unitId" text NOT NULL,
	"channel" Channel,
	"name" text NOT NULL,
	"startDate" timestamp NOT NULL,
	"endDate" timestamp NOT NULL,
	"baseRate" numeric(12, 3) NOT NULL,
	"weekendRate" numeric(12, 3),
	"minNights" integer DEFAULT 1 NOT NULL,
	"maxNights" integer,
	"stopSell" boolean DEFAULT false NOT NULL,
	"daysOfWeek" jsonb,
	"priority" integer DEFAULT 0 NOT NULL,
	"createdAt" timestamp DEFAULT CURRENT_TIMESTAMP NOT NULL,
	"updatedAt" timestamp NOT NULL
);
CREATE TABLE "Unit" (
	"id" text PRIMARY KEY,
	"name" text NOT NULL,
	"code" text,
	"isActive" boolean DEFAULT true NOT NULL,
	"currency" text DEFAULT 'BHD' NOT NULL,
	"defaultRate" numeric(12, 3),
	"createdAt" timestamp DEFAULT CURRENT_TIMESTAMP NOT NULL,
	"updatedAt" timestamp NOT NULL
);
CREATE TABLE "UnitContent" (
	"id" text PRIMARY KEY,
	"unitId" text NOT NULL,
	"title" text,
	"description" text,
	"houseRules" text,
	"checkInInfo" text,
	"checkOutInfo" text,
	"amenities" jsonb,
	"images" jsonb,
	"locationNote" text,
	"address" text,
	"guestCapacity" text,
	"propertyHighlights" text,
	"nearbyPlaces" text,
	"damageDeposit" text,
	"cancellationPolicy" text,
	"addressLine1" text,
	"city" text,
	"country" text,
	"lat" double precision,
	"lng" double precision,
	"createdAt" timestamp DEFAULT CURRENT_TIMESTAMP NOT NULL,
	"updatedAt" timestamp NOT NULL
);
CREATE TABLE "neon_auth"."account" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid(),
	"accountId" text NOT NULL,
	"providerId" text NOT NULL,
	"userId" uuid NOT NULL,
	"accessToken" text,
	"refreshToken" text,
	"idToken" text,
	"accessTokenExpiresAt" timestamp with time zone,
	"refreshTokenExpiresAt" timestamp with time zone,
	"scope" text,
	"password" text,
	"createdAt" timestamp with time zone DEFAULT CURRENT_TIMESTAMP NOT NULL,
	"updatedAt" timestamp with time zone NOT NULL
);
CREATE TABLE "neon_auth"."invitation" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid(),
	"organizationId" uuid NOT NULL,
	"email" text NOT NULL,
	"role" text,
	"status" text NOT NULL,
	"expiresAt" timestamp with time zone NOT NULL,
	"createdAt" timestamp with time zone DEFAULT CURRENT_TIMESTAMP NOT NULL,
	"inviterId" uuid NOT NULL
);
CREATE TABLE "neon_auth"."jwks" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid(),
	"publicKey" text NOT NULL,
	"privateKey" text NOT NULL,
	"createdAt" timestamp with time zone NOT NULL,
	"expiresAt" timestamp with time zone
);
CREATE TABLE "neon_auth"."member" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid(),
	"organizationId" uuid NOT NULL,
	"userId" uuid NOT NULL,
	"role" text NOT NULL,
	"createdAt" timestamp with time zone NOT NULL
);
CREATE TABLE "neon_auth"."organization" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid(),
	"name" text NOT NULL,
	"slug" text NOT NULL CONSTRAINT "organization_slug_key" UNIQUE,
	"logo" text,
	"createdAt" timestamp with time zone NOT NULL,
	"metadata" text
);
CREATE TABLE "neon_auth"."project_config" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid(),
	"name" text NOT NULL,
	"endpoint_id" text NOT NULL CONSTRAINT "project_config_endpoint_id_key" UNIQUE,
	"created_at" timestamp with time zone DEFAULT CURRENT_TIMESTAMP NOT NULL,
	"updated_at" timestamp with time zone DEFAULT CURRENT_TIMESTAMP NOT NULL,
	"trusted_origins" jsonb NOT NULL,
	"social_providers" jsonb NOT NULL,
	"email_provider" jsonb,
	"email_and_password" jsonb,
	"allow_localhost" boolean NOT NULL
);
CREATE TABLE "neon_auth"."session" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid(),
	"expiresAt" timestamp with time zone NOT NULL,
	"token" text NOT NULL CONSTRAINT "session_token_key" UNIQUE,
	"createdAt" timestamp with time zone DEFAULT CURRENT_TIMESTAMP NOT NULL,
	"updatedAt" timestamp with time zone NOT NULL,
	"ipAddress" text,
	"userAgent" text,
	"userId" uuid NOT NULL,
	"impersonatedBy" text,
	"activeOrganizationId" text
);
CREATE TABLE "neon_auth"."user" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid(),
	"name" text NOT NULL,
	"email" text NOT NULL CONSTRAINT "user_email_key" UNIQUE,
	"emailVerified" boolean NOT NULL,
	"image" text,
	"createdAt" timestamp with time zone DEFAULT CURRENT_TIMESTAMP NOT NULL,
	"updatedAt" timestamp with time zone DEFAULT CURRENT_TIMESTAMP NOT NULL,
	"role" text,
	"banned" boolean,
	"banReason" text,
	"banExpires" timestamp with time zone
);
CREATE TABLE "neon_auth"."verification" (
	"id" uuid PRIMARY KEY DEFAULT gen_random_uuid(),
	"identifier" text NOT NULL,
	"value" text NOT NULL,
	"expiresAt" timestamp with time zone NOT NULL,
	"createdAt" timestamp with time zone DEFAULT CURRENT_TIMESTAMP NOT NULL,
	"updatedAt" timestamp with time zone DEFAULT CURRENT_TIMESTAMP NOT NULL
);
ALTER TABLE "Booking" ADD CONSTRAINT "Booking_unitId_fkey" FOREIGN KEY ("unitId") REFERENCES "Unit"("id") ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE "ChannelContent" ADD CONSTRAINT "ChannelContent_unitContentId_fkey" FOREIGN KEY ("unitContentId") REFERENCES "UnitContent"("id") ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE "ChannelListing" ADD CONSTRAINT "ChannelListing_unitId_fkey" FOREIGN KEY ("unitId") REFERENCES "Unit"("id") ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE "ChannelOpsSnapshot" ADD CONSTRAINT "ChannelOpsSnapshot_unitId_fkey" FOREIGN KEY ("unitId") REFERENCES "Unit"("id") ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE "DateBlock" ADD CONSTRAINT "DateBlock_unitId_fkey" FOREIGN KEY ("unitId") REFERENCES "Unit"("id") ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE "Expense" ADD CONSTRAINT "Expense_unitId_fkey" FOREIGN KEY ("unitId") REFERENCES "Unit"("id") ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE "IcalFeed" ADD CONSTRAINT "IcalFeed_unitId_fkey" FOREIGN KEY ("unitId") REFERENCES "Unit"("id") ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE "PayoutLine" ADD CONSTRAINT "PayoutLine_bookingId_fkey" FOREIGN KEY ("bookingId") REFERENCES "Booking"("id") ON DELETE SET NULL ON UPDATE CASCADE;
ALTER TABLE "PayoutLine" ADD CONSTRAINT "PayoutLine_payoutId_fkey" FOREIGN KEY ("payoutId") REFERENCES "Payout"("id") ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE "PublishSnapshot" ADD CONSTRAINT "PublishSnapshot_unitId_fkey" FOREIGN KEY ("unitId") REFERENCES "Unit"("id") ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE "RateRule" ADD CONSTRAINT "RateRule_unitId_fkey" FOREIGN KEY ("unitId") REFERENCES "Unit"("id") ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE "UnitContent" ADD CONSTRAINT "UnitContent_unitId_fkey" FOREIGN KEY ("unitId") REFERENCES "Unit"("id") ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE "neon_auth"."account" ADD CONSTRAINT "account_userId_fkey" FOREIGN KEY ("userId") REFERENCES "neon_auth"."user"("id") ON DELETE CASCADE;
ALTER TABLE "neon_auth"."invitation" ADD CONSTRAINT "invitation_inviterId_fkey" FOREIGN KEY ("inviterId") REFERENCES "neon_auth"."user"("id") ON DELETE CASCADE;
ALTER TABLE "neon_auth"."invitation" ADD CONSTRAINT "invitation_organizationId_fkey" FOREIGN KEY ("organizationId") REFERENCES "neon_auth"."organization"("id") ON DELETE CASCADE;
ALTER TABLE "neon_auth"."member" ADD CONSTRAINT "member_organizationId_fkey" FOREIGN KEY ("organizationId") REFERENCES "neon_auth"."organization"("id") ON DELETE CASCADE;
ALTER TABLE "neon_auth"."member" ADD CONSTRAINT "member_userId_fkey" FOREIGN KEY ("userId") REFERENCES "neon_auth"."user"("id") ON DELETE CASCADE;
ALTER TABLE "neon_auth"."session" ADD CONSTRAINT "session_userId_fkey" FOREIGN KEY ("userId") REFERENCES "neon_auth"."user"("id") ON DELETE CASCADE;
CREATE UNIQUE INDEX "Booking_pkey" ON "Booking" ("id");
CREATE UNIQUE INDEX "Booking_unitId_channel_externalUid_key" ON "Booking" ("unitId","channel","externalUid");
CREATE INDEX "Booking_unitId_startDate_endDate_idx" ON "Booking" ("unitId","startDate","endDate");
CREATE UNIQUE INDEX "ChannelContent_pkey" ON "ChannelContent" ("id");
CREATE INDEX "ChannelContent_unitContentId_channel_idx" ON "ChannelContent" ("unitContentId","channel");
CREATE UNIQUE INDEX "ChannelContent_unitContentId_channel_key" ON "ChannelContent" ("unitContentId","channel");
CREATE UNIQUE INDEX "ChannelListing_channel_externalId_key" ON "ChannelListing" ("channel","externalId");
CREATE UNIQUE INDEX "ChannelListing_pkey" ON "ChannelListing" ("id");
CREATE INDEX "ChannelListing_unitId_idx" ON "ChannelListing" ("unitId");
CREATE UNIQUE INDEX "ChannelOpsSnapshot_pkey" ON "ChannelOpsSnapshot" ("id");
CREATE INDEX "ChannelOpsSnapshot_unitId_capturedAt_idx" ON "ChannelOpsSnapshot" ("unitId","capturedAt");
CREATE UNIQUE INDEX "DateBlock_pkey" ON "DateBlock" ("id");
CREATE INDEX "DateBlock_unitId_date_idx" ON "DateBlock" ("unitId","date");
CREATE UNIQUE INDEX "DateBlock_unitId_date_key" ON "DateBlock" ("unitId","date");
CREATE UNIQUE INDEX "Expense_pkey" ON "Expense" ("id");
CREATE INDEX "Expense_unitId_spentAt_idx" ON "Expense" ("unitId","spentAt");
CREATE UNIQUE INDEX "IcalFeed_pkey" ON "IcalFeed" ("id");
CREATE INDEX "IcalFeed_unitId_channel_idx" ON "IcalFeed" ("unitId","channel");
CREATE UNIQUE INDEX "Payout_pkey" ON "Payout" ("id");
CREATE INDEX "PayoutLine_bookingId_idx" ON "PayoutLine" ("bookingId");
CREATE INDEX "PayoutLine_payoutId_idx" ON "PayoutLine" ("payoutId");
CREATE UNIQUE INDEX "PayoutLine_pkey" ON "PayoutLine" ("id");
CREATE UNIQUE INDEX "PublicPreviewCache_pkey" ON "PublicPreviewCache" ("id");
CREATE INDEX "PublicPreviewCache_url_idx" ON "PublicPreviewCache" ("url");
CREATE UNIQUE INDEX "PublicPreviewCache_url_key" ON "PublicPreviewCache" ("url");
CREATE UNIQUE INDEX "PublishSnapshot_pkey" ON "PublishSnapshot" ("id");
CREATE INDEX "PublishSnapshot_unitId_channel_section_publishedAt_idx" ON "PublishSnapshot" ("unitId","channel","section","publishedAt");
CREATE UNIQUE INDEX "RateRule_pkey" ON "RateRule" ("id");
CREATE INDEX "RateRule_unitId_startDate_endDate_idx" ON "RateRule" ("unitId","startDate","endDate");
CREATE UNIQUE INDEX "Unit_pkey" ON "Unit" ("id");
CREATE UNIQUE INDEX "UnitContent_pkey" ON "UnitContent" ("id");
CREATE UNIQUE INDEX "UnitContent_unitId_key" ON "UnitContent" ("unitId");
CREATE UNIQUE INDEX "account_pkey" ON "neon_auth"."account" ("id");
CREATE INDEX "account_userId_idx" ON "neon_auth"."account" ("userId");
CREATE INDEX "invitation_email_idx" ON "neon_auth"."invitation" ("email");
CREATE INDEX "invitation_organizationId_idx" ON "neon_auth"."invitation" ("organizationId");
CREATE UNIQUE INDEX "invitation_pkey" ON "neon_auth"."invitation" ("id");
CREATE UNIQUE INDEX "jwks_pkey" ON "neon_auth"."jwks" ("id");
CREATE INDEX "member_organizationId_idx" ON "neon_auth"."member" ("organizationId");
CREATE UNIQUE INDEX "member_pkey" ON "neon_auth"."member" ("id");
CREATE INDEX "member_userId_idx" ON "neon_auth"."member" ("userId");
CREATE UNIQUE INDEX "organization_pkey" ON "neon_auth"."organization" ("id");
CREATE UNIQUE INDEX "organization_slug_key" ON "neon_auth"."organization" ("slug");
CREATE UNIQUE INDEX "organization_slug_uidx" ON "neon_auth"."organization" ("slug");
CREATE UNIQUE INDEX "project_config_endpoint_id_key" ON "neon_auth"."project_config" ("endpoint_id");
CREATE UNIQUE INDEX "project_config_pkey" ON "neon_auth"."project_config" ("id");
CREATE UNIQUE INDEX "session_pkey" ON "neon_auth"."session" ("id");
CREATE UNIQUE INDEX "session_token_key" ON "neon_auth"."session" ("token");
CREATE INDEX "session_userId_idx" ON "neon_auth"."session" ("userId");
CREATE UNIQUE INDEX "user_email_key" ON "neon_auth"."user" ("email");
CREATE UNIQUE INDEX "user_pkey" ON "neon_auth"."user" ("id");
CREATE INDEX "verification_identifier_idx" ON "neon_auth"."verification" ("identifier");
CREATE UNIQUE INDEX "verification_pkey" ON "neon_auth"."verification" ("id");